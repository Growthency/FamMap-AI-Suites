<!DOCTYPE html>
<html lang="sv">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fam Map Description Maker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="style.css" />
    <style>
      body {
        font-family: "Inter", sans-serif;
        scroll-behavior: smooth;
      }

      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3b82f6;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }

        100% {
          transform: rotate(360deg);
        }
      }

      #generated-description h3 {
        font-size: 1.25rem;
        /* 20px */
        line-height: 1.75rem;
        /* 28px */
        font-weight: 700;
        margin-bottom: 0.5rem;
      }

      #generated-description p {
        margin-bottom: 1rem;
      }

      #generated-description ul {
        list-style-type: none;
        padding-left: 0;
        margin-top: 1rem;
      }

      #generated-description li {
        margin-bottom: 0.75rem;
        padding-left: 2rem;
        position: relative;
      }

      #generated-description li::before {
        position: absolute;
        left: 0;
        top: 2px;
        font-size: 1.25rem;
      }

      #generated-description li:nth-of-type(1)::before {
        content: "üçÄ";
      }

      #generated-description li:nth-of-type(2)::before {
        content: "üë®‚Äçüë©‚Äçüëß";
      }

      #generated-description li:nth-of-type(3)::before {
        content: "üéâ";
      }

      #generated-description .conclusion {
        margin-top: 1.5rem;
      }
    </style>
  </head>

  <body class="bg-gray-100 text-gray-800 antialiased bg-white">
    <!-- Header -->
    <header
      class="bg-white/80 backdrop-blur-xl sticky top-0 z-50 shadow-sm border-b border-gray-200/50"
    >
      <div class="container mx-auto px-6 py-4">
        <div class="flex items-center justify-between">
          <a href="https://fam-map-ai-suites.vercel.app/" class="flex items-center gap-2">
            <img src="fam.png" alt="" class="famlogo" />
          </a>
          <div class="hidden md:flex items-center space-x-8">
            <a
              href="eventresearcher.html"
              class="text-gray-600 hover:text-indigo-600 font-medium transition-colors duration-300"
              >FamEvent</a
            >
            <a
              href="Short-Description.html"
              class="text-gray-600 hover:text-indigo-600 font-medium transition-colors duration-300"
              >FamiShort</a
            >
            <a
              href="universal.html"
              class="text-gray-600 hover:text-indigo-600 font-medium transition-colors duration-300"
              >FamUniversal</a
            >
            <a
              href="Ideagenerator.html"
              class="text-gray-600 hover:text-indigo-600 font-medium transition-colors duration-300"
              >FamIdea</a
            >
          </div>
          <div class="md:hidden">
            <button
              id="mobile-menu-button"
              class="text-gray-800 focus:outline-none"
            >
              <svg
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M4 6h16M4 12h16m-7 6h7"
                />
              </svg>
            </button>
          </div>
        </div>
        <!-- Mobile Menu -->
        <div id="mobile-menu" class="hidden md:hidden mt-4">
          <nav class="flex flex-col space-y-2">
            <a
              href="eventresearcher.html"
              class="text-gray-600 hover:bg-indigo-50 rounded-lg p-2 font-medium transition-colors duration-300"
              >FamEvent</a
            >
            <a
              href="Short-Description.html"
              class="text-gray-600 hover:bg-indigo-50 rounded-lg p-2 font-medium transition-colors duration-300"
              >FamiShort</a
            >
            <a
              href="universal.html"
              class="text-gray-600 hover:bg-indigo-50 rounded-lg p-2 font-medium transition-colors duration-300"
              >FamUniversal</a
            >
            <a
              href="Ideagenerator.html"
              class="text-gray-600 hover:bg-indigo-50 rounded-lg p-2 font-medium transition-colors duration-300"
              >FamIdea</a
            >
            >
          </nav>
        </div>
      </div>
    </header>
    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-4xl universalheigh">
      <!-- Header -->
      <header class="text-center mb-10">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-900 tracking-tight">
          Fam Map Description Maker
        </h1>
        <p class="text-gray-600 mt-2 text-lg">
          Skriv in f√∂retagsnamn och URL f√∂r att skapa en unik beskrivning!
        </p>
      </header>

      <!-- Input Form Card -->
      <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8 mb-8">
        <form id="description-form">
          <div class="space-y-6">
            <div>
              <label
                for="company-name"
                class="block text-sm font-medium text-gray-700 mb-2"
                >F√∂retagsnamn</label
              >
              <input
                type="text"
                id="company-name"
                name="company-name"
                placeholder="Ex: Sollentuna Bibliotek"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
              />
            </div>
            <div>
              <label
                for="company-url"
                class="block text-sm font-medium text-gray-700 mb-2"
                >Hemsida (URL)</label
              >
              <input
                type="url"
                id="company-url"
                name="company-url"
                placeholder="https://www.bibliotekenisollentuna.se"
                required
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 shadow-sm"
              />
            </div>
          </div>
          <div class="mt-8 text-center">
            <button
              type="submit"
              id="generate-btn"
              class="inline-flex items-center justify-center bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-transform transform hover:scale-105 disabled:bg-gray-400 disabled:scale-100 shadow-lg"
            >
              <span>Skapa Beskrivning</span>
            </button>
          </div>
        </form>
      </div>

      <!-- Output Section -->
      <div id="output-section" class="hidden">
        <!-- Loader -->
        <div id="loader" class="hidden flex justify-center items-center my-10">
          <div class="loader"></div>
          <p id="loader-text" class="ml-4 text-gray-600 text-lg">
            Skapar din unika beskrivning... ett √∂gonblick...
          </p>
        </div>

        <!-- Error Message -->
        <div
          id="error-message"
          class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg"
          role="alert"
        >
          <p class="font-bold">Ett fel uppstod</p>
          <p>
            Kunde inte skapa beskrivning. Samtliga API-nycklar misslyckades.
            F√∂rs√∂k igen senare.
          </p>
        </div>

        <!-- Result Card -->
        <div
          id="result-card"
          class="hidden bg-white rounded-2xl shadow-lg p-6 sm:p-8"
        >
          <h2 class="text-2xl font-bold text-gray-900 mb-5 border-b pb-3">
            Genererad Beskrivning
          </h2>
          <div
            id="generated-description"
            class="prose max-w-none text-gray-800 bg-gray-50 p-6 rounded-lg border border-gray-200"
          >
            <!-- Generated content will appear here -->
          </div>
          <div class="mt-6 flex justify-end">
            <button
              id="copy-button"
              class="bg-green-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition-transform transform hover:scale-105 shadow-md"
            >
              Kopiera Text
            </button>
          </div>
        </div>
      </div>
    </div>
    <!-- Footer -->
    <footer class="text-center py-10 border-t bg-white">
      <div class="container mx-auto">
        <p class="text-gray-500">
          &copy; 2025 FamMap. Alla r√§ttigheter f√∂rbeh√•llna.
        </p>
      </div>
    </footer>
    <script>
      // --- DOM Elements ---
      const descriptionForm = document.getElementById("description-form");
      const generateBtn = document.getElementById("generate-btn");
      const outputSection = document.getElementById("output-section");
      const loader = document.getElementById("loader");
      const loaderText = document.getElementById("loader-text");
      const errorMessage = document.getElementById("error-message");
      const resultCard = document.getElementById("result-card");
      const generatedDescriptionDiv = document.getElementById(
        "generated-description"
      );
      const copyButton = document.getElementById("copy-button");

      // --- API Configuration ---
      const apiKeys = [
        "AIzaSyCfuY7h20oMxB2strUFKSoG_1-DlOsJcIs", // Your API Key will be placed here by Canvas
        "AIzaSyCc53TwSEIWQzUjATy-5lpXIGyZSM04tpI", // Your API Key will be placed here by Canvas
        "AIzaSyAN_jn4dzxXNLbyAbJ2H9fyoqDkSpEei6o", // Your API Key will be placed here by Canvas
        "AIzaSyAFNA92_GhCkc8aOI-UAbteO50fW-ep55g", // Your API Key will be placed here by Canvas
        "", // Your API Key will be placed here by Canvas
      ];
      const apiUrlBase = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=`;

      // --- Event Listeners ---
      descriptionForm.addEventListener("submit", handleFormSubmit);
      copyButton.addEventListener("click", copyToClipboard);

      // --- Main Functions ---
      async function handleFormSubmit(event) {
        event.preventDefault();
        const companyName = document
          .getElementById("company-name")
          .value.trim();
        const companyUrl = document.getElementById("company-url").value.trim();

        if (!companyName || !companyUrl) {
          alert("V√§nligen fyll i b√•da f√§lten.");
          return;
        }

        setLoadingState(true);

        const updateStatus = (message) => {
          loaderText.textContent = message;
        };

        const systemPrompt = `You are a world-class creative copywriter for a Swedish family activity app called "Fam Map". Your task is to write short, appealing, and unique descriptions of various places. The language must be perfect, modern Swedish.

            **Critical Rules:**
            1.  **Be Honest & Evaluate:** First, evaluate the URL and company name. If the place is genuinely a fun and suitable activity for a family with children (e.g., library, museum, playground, sports club with kids' activities), write an enthusiastic description.
            2.  **Handle Non-Family Places:** If the place is NOT a direct family activity (e.g., an IT company, a business organization, a members-only club for adults), DO NOT pretend it is. Instead, write an honest description from the angle of how its work or existence positively impacts the local community and families indirectly. For example, a business organization creates a better town for families to live in.
            3.  **Be Unique & Authentic:** Your client hates repetitive phrases. AVOID clich√©s like "en plats f√∂r hela familjen". Focus on what makes EACH place special. Use varied and creative headings and language.
            4.  **Strict Format (but creative content):** You MUST follow the structure below. However, the content within the structure (titles, headings, points) must be unique and creative each time. Do not use the same heading twice.
            5. Headline shall only have the first letter in cap.

            **Output Format (ONLY this format is allowed):**
            ***

            **[Creative and catchy title in Swedish with a relevant emoji]**

            [A short, inviting, and unique introduction in Swedish. 1-2 sentences.] ‚ú®

            **[A creative and unique heading in Swedish]**

            üçÄ [Unique selling point 1 in Swedish, focusing on kids/family if appropriate, or community benefit.]

            üë®‚Äçüë©‚Äçüëß [Unique selling point 2 in Swedish, focusing on the family experience or community benefit.]

            üéâ [Unique selling point 3 in Swedish, focusing on a special feature, value, or feeling.]

            [A powerful and inspiring concluding sentence in Swedish.] ‚ù§Ô∏è
            `;

        const userPrompt = `Company Name: ${companyName}\nURL: ${companyUrl}\n\nPlease generate the description based on the rules and format.`;

        try {
          const description = await callGeminiAPIWithRetries(
            systemPrompt,
            userPrompt,
            updateStatus
          );
          displayDescription(description);
        } catch (error) {
          console.error("All API keys failed:", error);
          displayError();
        } finally {
          setLoadingState(false);
        }
      }

      async function callGeminiAPIWithRetries(
        systemPrompt,
        userPrompt,
        updateStatusCallback,
        keyIndex = 0,
        attempt = 1
      ) {
        if (keyIndex >= apiKeys.length) {
          throw new Error("All API keys have been tried and failed.");
        }

        const apiKey = apiKeys[keyIndex];
        const apiUrl = apiUrlBase + apiKey;

        const payload = {
          contents: [{ parts: [{ text: userPrompt }] }],
          systemInstruction: {
            parts: [{ text: systemPrompt }],
          },
          generationConfig: {
            temperature: 0.8,
            maxOutputTokens: 1024,
          },
        };

        try {
          const response = await fetch(apiUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            if (response.status === 429 || response.status >= 500) {
              console.warn(
                `API call with key index ${keyIndex} failed (Status: ${response.status}). Retrying with next key...`
              );
              if (updateStatusCallback)
                updateStatusCallback(
                  `Anslutningen misslyckades (f√∂rs√∂k ${attempt}/${apiKeys.length}). F√∂rs√∂ker igen...`
                );
              const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
              await new Promise((resolve) => setTimeout(resolve, delay));
              return await callGeminiAPIWithRetries(
                systemPrompt,
                userPrompt,
                updateStatusCallback,
                keyIndex + 1,
                attempt + 1
              );
            }
            throw new Error(`API call failed with status: ${response.status}`);
          }

          const result = await response.json();

          if (
            result.candidates &&
            result.candidates[0].content &&
            result.candidates[0].content.parts[0].text
          ) {
            return result.candidates[0].content.parts[0].text;
          } else if (
            result.promptFeedback &&
            result.promptFeedback.blockReason
          ) {
            console.warn(
              `API call with key index ${keyIndex} blocked. Reason: ${result.promptFeedback.blockReason}. Retrying with next key...`
            );
            if (updateStatusCallback)
              updateStatusCallback(
                `F√∂rs√∂k ${attempt}/${apiKeys.length} blockerades. F√∂rs√∂ker igen...`
              );
            return await callGeminiAPIWithRetries(
              systemPrompt,
              userPrompt,
              updateStatusCallback,
              keyIndex + 1,
              attempt + 1
            );
          } else {
            throw new Error("Invalid response from Gemini API.");
          }
        } catch (error) {
          console.error(`Error with key index ${keyIndex}:`, error);
          if (updateStatusCallback)
            updateStatusCallback(
              `Ett fel uppstod (f√∂rs√∂k ${attempt}/${apiKeys.length}). F√∂rs√∂ker igen...`
            );
          const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
          await new Promise((resolve) => setTimeout(resolve, delay));
          return await callGeminiAPIWithRetries(
            systemPrompt,
            userPrompt,
            updateStatusCallback,
            keyIndex + 1,
            attempt + 1
          );
        }
      }

      // --- UI Helper Functions ---
      function displayDescription(text) {
        const cleanText = text.replace(/[*]{2,}/g, "").trim(); // Remove *** and **
        const lines = cleanText
          .split("\n")
          .filter((line) => line.trim() !== "");

        if (lines.length < 6) {
          generatedDescriptionDiv.innerText = cleanText;
        } else {
          const title = lines[0] || "";
          const intro = lines[1] || "";
          const heading = lines[2] || "";
          const point1 = lines[3] || "";
          const point2 = lines[4] || "";
          const point3 = lines[5] || "";
          const conclusion = lines.slice(6).join("<br>") || "";

          const html = `
                    <h3>${title}</h3>
                    <p>${intro}</p>
                    <p class="font-bold text-lg">${heading}</p>
                    <ul>
                        <li>${point1.substring(point1.indexOf(" "))}</li>
                        <li>${point2.substring(point2.indexOf(" "))}</li>
                        <li>${point3.substring(point3.indexOf(" "))}</li>
                    </ul>
                    <p class="conclusion">${conclusion}</p>
                `;
          generatedDescriptionDiv.innerHTML = html;
        }

        resultCard.classList.remove("hidden");
        resultCard.scrollIntoView({ behavior: "smooth", block: "start" });
      }

      function displayError() {
        errorMessage.classList.remove("hidden");
        errorMessage.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function setLoadingState(isLoading) {
        outputSection.classList.remove("hidden");
        if (isLoading) {
          loaderText.textContent =
            "Skapar din unika beskrivning... ett √∂gonblick..."; // Reset text
          loader.classList.remove("hidden");
          resultCard.classList.add("hidden");
          errorMessage.classList.add("hidden");
          generateBtn.disabled = true;
          generateBtn.querySelector("span").textContent = "Skapar...";
        } else {
          loader.classList.add("hidden");
          generateBtn.disabled = false;
          generateBtn.querySelector("span").textContent = "Skapa Beskrivning";
        }
      }

      function copyToClipboard() {
        const textToCopy = generatedDescriptionDiv.innerText.trim();
        const tempInput = document.createElement("textarea");
        tempInput.style.position = "absolute";
        tempInput.style.left = "-9999px";
        tempInput.value = textToCopy;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);

        copyButton.textContent = "Kopierad!";
        setTimeout(() => {
          copyButton.textContent = "Kopiera Text";
        }, 2000);
      }
    </script>
  </body>
</html>
